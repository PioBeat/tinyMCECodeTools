tinymce.PluginManager.add('preCode', function (editor, url) {

    var options = [
        {value: "cpp", text: "C++"},
        {value: "php", text: "PHP"},
        {value: "javascript", text: "JavaScript"},
        {value: "r", text: "R"},
        {value: "clike", text: "C-like"},
        {value: "markup", text: "Markup"},
        {value: "none", text: "None"},
    ];

    function showDialog() {
        var selectedNode = editor.selection.getNode(), source = '';
        console.log("selectedNode", selectedNode);
        if (selectedNode.tagName === 'PRE' || selectedNode.tagName === 'CODE') {
            source = selectedNode.textContent;
            console.log("source before=", source);
            //sanitize
            source = source.replace(/<br>/g, "\r\n");
            console.log("source after=", source);
        }
        var label = {
            type: 'label',
            text: 'Paste your code below:',
            forId: 'source'
        }
        var sourceTextbox = {
            id: 'source',
            type: 'textbox',
            flex: 1,
            name: 'source',
            value: source,
            multiline: true,
//            label: 'Source',
            style: 'direction: ltr; text-align: left',
            minWidth: editor.getParam("code_dialog_width", 600),
            minHeight: editor.getParam("code_dialog_height", Math.min(tinymce.DOM.getViewPort().h - 200, 500))
        };
        var listbox = {
            type: 'listbox',
            name: 'lang',
            label: 'Language',
            'values': options
        }
        editor.windowManager.open({
            title: "Insert code element",
            body: [
                label, sourceTextbox, listbox
            ],
            onsubmit: function (e) {
                var code = e.data.source;
                var lang = e.data.lang;
                console.log("data=", code, lang);
                //var code = code.replace(/&/g, "&amp;").replace(/>/g, "&gt;").replace(/</g, "&lt;").replace(/"/g, "&quot;");
                code = "<pre><code class=\"language-" + lang + "\">" + code + "</code></pre>";
                console.log("submit code=", code);
               
                if (source === '') {
                    editor.execCommand('mceInsertContent', false, code);
                } else {
                    selectedNode.innerHTML = code;
                }
                //https://stackoverflow.com/questions/1253303/whats-the-best-way-to-set-cursor-caret-position
                editor.focus();
                var endId = tinymce.DOM.uniqueId();
                editor.dom.add(editor.getBody(), 'span', {'id': endId}, '');
//                editor.execCommand('mceInsertContent', false, '<span id="'+ endId + '"></span>');
                var newNode = editor.dom.select('span#' + endId);
                editor.selection.select(newNode[0]);
                editor.selection.collapse(0);
//                editor.dom.setAttrib(endId, 'id', '');
//                editor.dom.remove(newNode);
            }
        });
    }

    editor.addButton('preCode', {
        id: 'preCodeID',
        text: '<pre>',
        icon: true,
        image: url + '/preCode.png',
        onclick: showDialog
    });
});
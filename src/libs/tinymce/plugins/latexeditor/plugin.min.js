tinymce.PluginManager.add('latexeditor', function (editor, url) {

    console.log("latexeditor:", url);

    function initValues() {
        var selectedNode = editor.selection.getNode();
        console.log("selectedNode", selectedNode);
        if (selectedNode.tagName === 'IMG') {
            source = selectedNode.getAttribute("alt");
            console.log("source", source);
            return source;
        }
        return "";
    }

    editor.addButton('latexeditorButton', {
        text: 'Latex Editor',
        id: 'latexeditorID',
        onclick: function () {
            var addParams = {
                sourceInput: initValues()
            };
            editor.windowManager.open({
                title: 'Latex Code Editor',
                url: url + '/dialog.html',
                width: "800px",
                height: "400px",
                buttons: [
                    {
                        text: 'Submit',
                        onclick: 'submit'
                    },
                    {
                        text: 'Close',
                        onclick: 'close'
                    }],
                onsubmit: function (e) {
                    console.log("submit=", e);
                    var shortcut = editor.windowManager.getParams();
                    console.log("getParams", shortcut);

                    var code = shortcut.data;
                    var divNode = document.createElement("div");
                    divNode.setAttribute("lang", "latex");
                    var imgNode = document.createElement("IMG");
                    imgNode.setAttribute("src", "http://latex.codecogs.com/gif.latex?" + code);
                    imgNode.setAttribute("alt", code);
                    divNode.appendChild(imgNode);
                    editor.selection.setNode(imgNode);
                }
            }, addParams);
        }
    });
});
